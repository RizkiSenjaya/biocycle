{% extends "base.html" %}
{% set active = "ml" %}
{% block title %}Machine Learning | BioCycle{% endblock %}

{% block content %}

<h4 class="mb-4">Machine Learning â€“ Klasifikasi Kompos & Biogas</h4>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card p-3 text-center">
            <h6>ðŸŒ± Kualitas Pupuk Kompos</h6>
            <p id="komposResult" class="fs-3 fw-bold mt-3 text-success">Memuat...</p>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-3 text-center">
            <h6>ðŸ”¥ Kualitas Bio Gas</h6>
            <p id="biogasResult" class="fs-3 fw-bold mt-3 text-primary">Memuat...</p>
        </div>
    </div>
</div>

<div class="card p-3 mb-4">
    <h6>ðŸ“Š Distribusi Kualitas Produk</h6>
    <canvas id="qualityChart" height="90"></canvas>
</div>

<div class="card p-3">
    <h6>ðŸ“‹ Riwayat Klasifikasi</h6>
    <table class="table table-striped mt-2">
        <thead>
            <tr>
                <th>No</th>
                <th>Tanggal</th>
                <th>Suhu</th>
                <th>Kelembapan</th>
                <th>Gas</th>
                <th>Kualitas Kompos</th>
                <th>Kualitas Biogas</th>
            </tr>
        </thead>
        <tbody id="mlTable">
            <tr><td colspan="7" class="text-center">Memuat data...</td></tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function fetchMLData() {
    const response = await fetch('/get_ml_data');
    const data = await response.json();
    if (!data || data.error) return;

    const tbody = document.getElementById("mlTable");
    tbody.innerHTML = "";

    data.forEach((d, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${i + 1}</td>
                <td>${d.timestamp}</td>
                <td>${d.temperature.toFixed(2)}</td>
                <td>${d.humidity.toFixed(2)}</td>
                <td>${d.mq.toFixed(2)}</td>
                <td><span class="badge bg-${d.kompos == 'A' ? 'success' : d.kompos == 'B' ? 'warning' : 'danger'}">${d.kompos}</span></td>
                <td><span class="badge bg-${d.biogas == 'A' ? 'primary' : d.biogas == 'B' ? 'info' : 'secondary'}">${d.biogas}</span></td>
            </tr>`;
    });

    const last = data[data.length - 1];
    document.getElementById("komposResult").innerText = `Kualitas ${last.kompos}`;
    document.getElementById("biogasResult").innerText = `Kualitas ${last.biogas}`;

    const komposCount = { A: 0, B: 0, C: 0 };
    const biogasCount = { A: 0, B: 0, C: 0 };

    data.forEach(d => {
        komposCount[d.kompos]++;
        biogasCount[d.biogas]++;
    });

    const ctx = document.getElementById('qualityChart').getContext('2d');
    if (window.mlChart) window.mlChart.destroy();
    window.mlChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['A', 'B', 'C'],
            datasets: [
                { label: 'Kompos', data: [komposCount.A, komposCount.B, komposCount.C], backgroundColor: 'rgba(75,192,192)' },
                { label: 'Biogas', data: [biogasCount.A, biogasCount.B, biogasCount.C], backgroundColor: 'rgba(153,102,255)' }
            ]
        }
    });
}

fetchMLData();
setInterval(fetchMLData, 5000);
</script>
{% endblock %}
