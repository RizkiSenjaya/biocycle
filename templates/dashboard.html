<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Dashboard | BioCycle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Tombol Toggle Sidebar (Mobile) -->
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="text-center mb-3">
            <a href="/profile">
                <img src="{{ user.photo }}" alt="Profile" class="profile-img">
            </a>
            <p class="mt-2 mb-0 fw-bold">{{ user.name }}</p>
            <small>{{ user.email }}</small>
        </div>

        <hr class="text-light">

        <a href="/dashboard" class="active">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="#">Machine Learning</a>
        <a href="#">Export File</a>
        <a href="#">Pengaturan</a>
        <a href="javascript:void(0)" onclick="logoutUser()" class="text-danger">Logout</a>
    </div>

    <!-- Konten utama -->
    <div class="content">
        <h4 class="mb-4">Monitoring Dashboard</h4>

        <!-- Kartu Data -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <h5>Suhu (°C)</h5>
                    <p class="data-value" id="temperature">-- °C</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <h5>Kelembapan (%)</h5>
                    <p class="data-value" id="humidity">-- %</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <h5>Gas (MQ)</h5>
                    <p class="data-value" id="mq">--</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center p-3">
                    <h5>Solenoid Valve</h5>
                    <p class="data-value" id="solenoid_valve">--</p>
                </div>
            </div>
        </div>

        <!-- Grafik -->
        <div class="card mb-4 p-3">
            <h6>Grafik Sensor Realtime</h6>
            <canvas id="sensorChart" height="90"></canvas>
        </div>

        <!-- Tabel Riwayat -->
        <div class="card p-3">
            <h6>Riwayat Data (10 Data Terakhir)</h6>
            <table class="table table-striped mt-2">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Suhu</th>
                        <th>Kelembapan</th>
                        <th>MQ</th>
                        <th>Motor</th>
                        <th>Solenoid</th>
                    </tr>
                </thead>
                <tbody id="sensorTable">
                    <tr><td colspan="6" class="text-center">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        function toggleSidebar() {
            document.getElementById("sidebar").classList.toggle("active");
        }

        const ctx = document.getElementById('sensorChart').getContext('2d');
        let chart;

        async function fetchData() {
            const response = await fetch('/get_sensor_history');
            const data = await response.json();

            const labels = data.map(row => row.timestamp);
            const temperature = data.map(row => row.temperature);
            const humidity = data.map(row => row.humidity);
            const mq = data.map(row => row.mq);

            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Suhu (°C)', data: temperature, borderColor: 'red', fill: false },
                        { label: 'Kelembapan (%)', data: humidity, borderColor: 'blue', fill: false },
                        { label: 'Gas (MQ)', data: mq, borderColor: 'orange', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false },
                        x: { display: true, title: { display: true, text: 'Waktu' } }
                    }
                }
            });

            // Tampilkan data terbaru di atas
            const tbody = document.getElementById('sensorTable');
            tbody.innerHTML = "";
            data.slice().reverse().forEach((row, i) => {
                tbody.innerHTML += `
                    <tr class="${i === 0 ? 'table-warning' : ''}">
                        <td>${row.timestamp}</td>
                        <td>${row.temperature.toFixed(2)}</td>
                        <td>${row.humidity.toFixed(2)}</td>
                        <td>${row.mq.toFixed(2)}</td>
                        <td>${row.motor_status}</td>
                        <td>${row.solenoid_valve}</td>
                    </tr>
                `;
            });

            // Update kartu data
            const latest = data[data.length - 1];
            document.getElementById('temperature').innerText = `${latest.temperature.toFixed(2)} °C`;
            document.getElementById('humidity').innerText = `${latest.humidity.toFixed(2)} %`;
            document.getElementById('mq').innerText = latest.mq.toFixed(2);
            document.getElementById('solenoid_valve').innerText = latest.solenoid_valve;
        }

        fetchData();
        setInterval(fetchData, 5000);
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script>
    const firebaseConfig = {
        apiKey: "AIzaSyB393qWoErLcFOhTd7MMpl_93iVUKynIF0",
        authDomain: "biocycle-2a810.firebaseapp.com",
        projectId: "biocycle-2a810",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    function logoutUser() {
        auth.signOut().then(() => {
        window.location.href = "/logout";
        });
    }
    </script>

</body>
</html>
