<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Dashboard | BioCycle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- Tombol Toggle Sidebar (untuk Mobile) -->
  <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="text-center mb-3">
      <a href="/profile">
        <img src="{{ user.get('photo', url_for('static', filename='default_profile.png')) }}" alt="Profile" class="profile-img">
      </a>
      <p class="mt-2 mb-0 fw-bold">{{ user.name }}</p>
      <small>{{ user.email }}</small>
    </div>

    <hr class="text-light">

    <a href="/dashboard" class="active">Dashboard</a>
    <a href="/profile">Profile</a>
    <a href="#">Machine Learning</a>
    <a href="#">Export File</a>
    <a href="#">Pengaturan</a>
    <a href="javascript:void(0)" onclick="logoutUser()" class="text-danger">Logout</a>
  </div>

  <!-- Konten Utama -->
  <div class="content">
    <h4 class="mb-4">Monitoring Dashboard</h4>

    <!-- Kartu Data -->
    <div class="row mb-3">
      <div class="col-md-3">
        <div class="card text-center p-3 shadow-sm">
          <h5>Suhu (°C)</h5>
          <p class="data-value" id="temperature">-- °C</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3 shadow-sm">
          <h5>Kelembapan (%)</h5>
          <p class="data-value" id="humidity">-- %</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3 shadow-sm">
          <h5>Gas (MQ)</h5>
          <p class="data-value" id="gas">--</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-3 shadow-sm">
          <h5>Solenoid Valve</h5>
          <p class="data-value" id="solenoid">--</p>
        </div>
      </div>
    </div>

    <!-- Grafik -->
    <div class="card mb-4 p-3 shadow-sm">
      <h6>Grafik Sensor Realtime</h6>
      <canvas id="sensorChart" height="90"></canvas>
    </div>

    <!-- Tabel Riwayat -->
    <div class="card p-3 shadow-sm">
      <h6>Riwayat Data (10 Data Terakhir)</h6>
      <table class="table table-striped mt-2 text-center">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Suhu</th>
            <th>Kelembapan</th>
            <th>Gas (MQ)</th>
            <th>Fan</th>
            <th>Solenoid</th>
          </tr>
        </thead>
        <tbody id="sensorTable">
          <tr><td colspan="6" class="text-center">Memuat data...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("active");
    }

    const ctx = document.getElementById('sensorChart').getContext('2d');
    let chart;

    async function fetchData() {
      try {
        const response = await fetch('/get_data');
        const data = await response.json();

        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('sensorTable').innerHTML =
            `<tr><td colspan="6" class="text-center">Tidak ada data tersedia</td></tr>`;
          return;
        }

        const labels = data.map(row => row.timestamp);
        const temperature = data.map(row => row.temperature);
        const humidity = data.map(row => row.humidity);
        const gas = data.map(row => row.gas);

        // Update Chart
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              { label: 'Suhu (°C)', data: temperature, borderColor: 'red', fill: false },
              { label: 'Kelembapan (%)', data: humidity, borderColor: 'blue', fill: false },
              { label: 'Gas (MQ)', data: gas, borderColor: 'orange', fill: false }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { display: true } },
            scales: {
              y: { beginAtZero: false },
              x: { display: true, title: { display: true, text: 'Waktu' } }
            }
          }
        });

        // Update Tabel
        const tbody = document.getElementById('sensorTable');
        tbody.innerHTML = "";
        data.slice().reverse().forEach((row, i) => {
          tbody.innerHTML += `
            <tr class="${i === 0 ? 'table-warning' : ''}">
              <td>${row.timestamp || '-'}</td>
              <td>${row.temperature?.toFixed(2) || '-'}</td>
              <td>${row.humidity?.toFixed(2) || '-'}</td>
              <td>${row.gas?.toFixed(2) || '-'}</td>
              <td>${row.fanStatus || '-'}</td>
              <td>${row.solenoid || '-'}</td>
            </tr>`;
        });

        // Update kartu data terbaru
        const latest = data[data.length - 1];
        document.getElementById('temperature').innerText = `${latest.temperature?.toFixed(2)} °C`;
        document.getElementById('humidity').innerText = `${latest.humidity?.toFixed(2)} %`;
        document.getElementById('gas').innerText = latest.gas?.toFixed(2);
        document.getElementById('solenoid').innerText = latest.solenoid || '-';

      } catch (err) {
        console.error('Error fetching data:', err);
      }
    }

    fetchData();
    setInterval(fetchData, 5000);

    // Logout Firebase
    function logoutUser() {
      if (typeof firebase !== 'undefined') {
        firebase.auth().signOut().then(() => {
          window.location.href = "/logout";
        });
      } else {
        window.location.href = "/logout";
      }
    }
  </script>

  <!-- Firebase Auth Logout -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB393qWoErLcFOhTd7MMpl_93iVUKynIF0",
      authDomain: "biocycle-2a810.firebaseapp.com",
      projectId: "biocycle-2a810"
    };
    firebase.initializeApp(firebaseConfig);
  </script>
</body>
</html>
