{% extends "base.html" %}

{% block content %}
<div class="container-fluid">

    <h4 class="mb-4 fw-bold">Monitoring Dashboard</h4>

    <!-- Kartu Data -->
    <div class="row mb-3">

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Suhu (°C)</h6>
                <p class="data-value" id="temperature">-- °C</p>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Kelembapan (%)</h6>
                <p class="data-value" id="humidity">-- %</p>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Gas (MQ)</h6>
                <p class="data-value" id="mq">--</p>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Tekanan (bar)</h6>
                <p class="data-value" id="pressure">-- bar</p>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Motor</h6>
                <p class="data-value" id="motor_status">--</p>
            </div>
        </div>

        <div class="col-md-2">
            <div class="card text-center p-3">
                <h6>Solenoid Valve</h6>
                <p class="data-value" id="solenoid_valve">--</p>
            </div>
        </div>

    </div>

    <!-- Grafik Sensor -->
    <h6 class="section-header">Grafik Sensor Realtime</h6>
    <div class="card mb-4 p-3">
        <canvas id="sensorChart" height="90"></canvas>
    </div>

    <!-- Riwayat Data -->
    <h6 class="section-header">Riwayat Data (10 Data Terakhir)</h6>

    <div class="card p-3">

        <table class="table mt-3">
            <thead>
                <tr>
                    <th>Waktu</th>
                    <th>Suhu (°C)</th>
                    <th>Kelembapan (%)</th>
                    <th>Tekanan (bar)</th>
                    <th>Gas (MQ)</th>
                    <th>Motor</th>
                    <th>Solenoid</th>
                </tr>
            </thead>

            <tbody id="sensorTable">
                <tr>
                    <td colspan="7" class="text-center">Memuat data...</td>
                </tr>
            </tbody>
        </table>

    </div>

</div>

<!-- SCRIPT FETCH DATA -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('sensorChart').getContext('2d');
    let chart;

    async function fetchData() {
        const res = await fetch('/get_sensor_history');
        const data = await res.json();

        const labels = data.map(row => row.timestamp);
        const temperature = data.map(row => row.temperature);
        const humidity = data.map(row => row.humidity);
        const mq = data.map(row => row.mq);
        const pressure = data.map(row => row.pressure);

        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Suhu (°C)', data: temperature, borderColor: 'red', fill: false },
                    { label: 'Kelembapan (%)', data: humidity, borderColor: 'blue', fill: false },
                    { label: 'Gas (MQ)', data: mq, borderColor: 'orange', fill: false },
                    { label: 'Tekanan (bar)', data: pressure, borderColor: 'green', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: false },
                    x: { display: true }
                }
            }
        });

        const tbody = document.getElementById('sensorTable');
        tbody.innerHTML = "";

        data.slice().reverse().forEach(row => {
            tbody.innerHTML += `
                <tr>
                    <td>${row.timestamp}</td>
                    <td>${row.temperature.toFixed(2)}</td>
                    <td>${row.humidity.toFixed(2)}</td>
                    <td>${row.pressure.toFixed(2)}</td>
                    <td>${row.mq.toFixed(2)}</td>
                    <td>${row.motor_status}</td>
                    <td>${row.solenoid_valve}</td>
                </tr>
            `;
        });

        const latest = data[data.length - 1];
        document.getElementById('temperature').innerText = latest.temperature.toFixed(2) + " °C";
        document.getElementById('humidity').innerText = latest.humidity.toFixed(2) + " %";
        document.getElementById('mq').innerText = latest.mq.toFixed(2);
        document.getElementById('pressure').innerText = latest.pressure.toFixed(2) + " bar";
        document.getElementById('motor_status').innerText = latest.motor_status;
        document.getElementById('solenoid_valve').innerText = latest.solenoid_valve;
    }

    fetchData();
    setInterval(fetchData, 5000);
</script>

{% endblock %}
